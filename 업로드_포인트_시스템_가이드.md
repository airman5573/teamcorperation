# 팀 협력 게임 플랫폼 - 파일 업로드 및 포인트 시스템 가이드

## 목차
1. [시스템 개요](#시스템-개요)
2. [업로드 모드 비교](#업로드-모드-비교)
3. [업로드 프로세스](#업로드-프로세스)
4. [임시저장 시스템](#임시저장-시스템)
5. [포인트 시스템](#포인트-시스템)
6. [파일 처리 및 검증](#파일-처리-및-검증)
7. [데이터베이스 구조](#데이터베이스-구조)
8. [제한사항 및 규칙](#제한사항-및-규칙)
9. [사용자 인터페이스](#사용자-인터페이스)
10. [기술적 구현](#기술적-구현)

---

## 시스템 개요

이 플랫폼은 **시간 제한이 있는 팀 기반 미션 게임**을 위한 파일 업로드 및 포인트 관리 시스템입니다. 팀원들이 미션 수행 증빙으로 사진이나 동영상을 업로드하면 포인트를 획득하는 구조로 되어 있습니다.

### 핵심 특징
- **실시간 타이머 기반 미션 관리**
- **임시저장/정식업로드 이중 모드**
- **자동화된 승인/반려 시스템**
- **팀별 독립적인 파일 관리**
- **다양한 포인트 카테고리**

---

## 업로드 모드 비교

시스템은 `tempBoxState` 값에 따라 두 가지 업로드 모드로 동작합니다.

### 정식 업로드 모드 (tempBoxState = false)

| 특징 | 설명 |
|------|------|
| **포인트 지급** | 업로드 즉시 `useable` 포인트로 지급 (즉시 사용 가능) |
| **파일 저장** | `dc_uploads.files` 필드에 직접 저장 |
| **타이머 검증** | 불필요 |
| **사용 시점** | 일반적인 자유 업로드 상황 |

### 임시저장 모드 (tempBoxState = true)

| 특징 | 설명 |
|------|------|
| **포인트 지급** | `temp` 포인트로 임시 저장 (즉시 사용 불가) |
| **파일 저장** | `dc_uploads.temp` 필드에 임시 저장 |
| **타이머 검증** | 필수 (타이머 실행 중이어야 업로드 가능) |
| **사용 시점** | 시간 제한 미션 진행 중 |
| **최종 처리** | 타이머 종료 시 자동 승인/반려 |

---

## 업로드 프로세스

### 1단계: 파일 선택 및 검증
```javascript
// 지원 파일 형식 검증
const mediaType = utils.mediaTypeCheck(file.name);
if (mediaType == null) {
    alert("지원되지 않는 파일 형식입니다");
}

// 파일 크기 검증 (150MB 제한)
if (file.size > 154288000) {
    alert("파일 사이즈는 150MB를 넘으면 안됩니다");
}
```

**지원 파일 형식:**
- **비디오**: 3gp, avi, mov, mp4, mpeg, ogg, ogv, webm, wmv
- **이미지**: jpeg, jpg, png, gif

### 2단계: 미리보기 생성
- **이미지**: EXIF 데이터 기반 자동 회전 보정
- **비디오**: HTML5 비디오 플레이어로 미리보기

### 3단계: 업로드 전 검증
1. **타이머 상태 확인** (`/user/timer-check`)
   - 임시저장 모드일 때만 필요
   - 팀별 타이머 실행 상태 및 남은 시간 검증

2. **업로드 간격 확인** (`/user/upload-interval-check`)
   - 최소 3분(180초) 간격 유지 필요
   - 연속 업로드 방지

### 4단계: 파일 업로드 실행
```javascript
// FormData 구성
const formData = new FormData();
formData.append('userFile', selectedFile);
formData.append('team', teamNumber);
formData.append('point', pointValue);
formData.append('tempBoxState', tempBoxState);
```

### 5단계: 서버 측 파일 저장
**저장 경로:** `public/user/uploads/{버전}/{팀번호}/{YYYY_MM_DD_HH_MM_SS.확장자}`

### 6단계: 데이터베이스 업데이트
- 포인트 테이블 업데이트 (`dc_points`)
- 업로드 기록 저장 (`dc_uploads`)
- 업로드 시간 갱신

### 7단계: 스택 파일 추가
업로드된 파일을 다운로드 대기 목록에 추가:
```javascript
await DCQuery.uploads.addStackFile(team, filename, false);
```

### 8단계: 클라이언트 상태 초기화
- 진행률 표시 숨김
- 파일 선택 초기화
- 미리보기 제거

---

## 임시저장 시스템

### 임시저장의 필요성
시간 제한 미션에서 **공정성 확보**와 **부정 방지**를 위해 도입된 시스템입니다.

#### 게임 시나리오
1. 관리자가 특정 미션에 대해 "임시저장 모드" 활성화
2. 각 팀에게 제한 시간(예: 30분) 부여
3. 팀원들이 미션 수행 중 증빙 파일 업로드
4. 타이머 종료 시 자동으로 승인/반려 결정

### 임시저장 → 정식 승인 프로세스

#### 승인 조건
```javascript
const td = laptime - (currentTime - startTime);
if (td >= 0) {
    // 시간 내 완료 → 승인
    await DCQuery.uploads.move(team);  // 파일 이동
    await DCQuery.points.move(team);   // 포인트 이동
}
```

#### 반려 조건
```javascript
if (td < 0) {
    // 시간 초과 → 반려
    await DCQuery.uploads.reset('temp', team);  // 임시 파일 삭제
    await DCQuery.points.reset('temp', team);   // 임시 포인트 삭제
}
```

### 포인트 이동 메커니즘
```javascript
// DCQuery.points.move() 함수
async move(team) {
    let result = await this.get('temp', team);
    let tempPoints = result[0].temp;
    
    // 임시 포인트를 정식 포인트로 이동
    await this.update({
        team,
        useable: tempPoints,    // 정식 포인트 추가
        temp: -tempPoints       // 임시 포인트 차감
    });
}
```

### 파일 이동 메커니즘
```javascript
// DCQuery.uploads.move() 함수
async move(team) {
    let result = await this.get(team);
    let tempFiles = JSON.parse(result[0].temp || '[]');
    let existingFiles = JSON.parse(result[0].files || '[]');
    
    // 임시 파일을 정식 파일 목록에 병합
    let newFiles = existingFiles.concat(tempFiles);
    
    await this.mysql.query(`
        UPDATE ${this.table} 
        SET files = '${JSON.stringify(newFiles)}', 
            temp = NULL, 
            uploadTime = 0 
        WHERE team = ${team}
    `);
}
```

---

## 포인트 시스템

### 포인트 카테고리
| 카테고리 | 설명 | 기본값 |
|----------|------|--------|
| `useable` | 사용 가능한 포인트 | - |
| `temp` | 임시 포인트 (승인 대기) | - |
| `timer` | 타이머 관련 포인트 | ±100 |
| `eniac` | 문장해독 포인트 | 20,000 |
| `puzzle` | 퍼즐 관련 포인트 | 1,000 |
| `bingo` | 빙고 포인트 | 1,000 |

### 업로드 포인트 지급
```javascript
const mappingPoints = {
    upload: 1000,  // 업로드당 기본 포인트
    // 기타 액션별 포인트...
};
```

### 포인트 처리 로직
```javascript
if (tempBoxState) {
    // 임시저장 모드: temp 포인트로 저장
    await DCQuery.points.update({
        team,
        temp: point,
    });
} else {
    // 정식 모드: 즉시 사용 가능한 포인트로 저장
    await DCQuery.points.update({
        team,
        useable: point,
    });
}
```

---

## 파일 처리 및 검증

### Multer 설정
```javascript
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        const team = req.body.team || req.session.loginData.team;
        const uploadPath = `public/user/uploads/${process.env.DCV}/${team}`;
        fs.ensureDirSync(uploadPath);  // 디렉토리 자동 생성
        cb(null, uploadPath);
    },
    filename: (req, file, cb) => {
        const date = utils.getYYYYMMDDHHMMSS();  // YYYY_MM_DD_HH_MM_SS
        const filename = date + path.extname(file.originalname);
        cb(null, filename);
    }
});
```

### 파일 크기 제한
- **클라이언트**: 150MB (154,288,000 bytes)
- **서버**: 100MB (multer 설정)

### 저장 경로 구조
```
public/user/uploads/
├── v1/              # 버전별 구분
│   ├── 1/           # 팀 번호
│   │   ├── 2024_01_15_14_30_25.jpg
│   │   └── 2024_01_15_14_35_10.mp4
│   └── 2/
└── v2/
```

---

## 데이터베이스 구조

### dc_uploads 테이블
```sql
CREATE TABLE `dc_uploads` (
    `team` int(11) unsigned NOT NULL AUTO_INCREMENT,
    `files` text,           -- 확정된 업로드 파일 목록 (JSON)
    `temp` text,            -- 임시 업로드 파일 목록 (JSON)  
    `uploadTime` int(11) DEFAULT '0',    -- 마지막 업로드 시간
    `stackFiles` mediumtext,             -- 다운로드 대기 파일들
    PRIMARY KEY (`team`)
);
```

### dc_points 테이블
```sql
CREATE TABLE IF NOT EXISTS `dc_points` (
    `team` int(11) unsigned NOT NULL AUTO_INCREMENT,
    `useable` int(11) DEFAULT '0',    -- 사용 가능한 포인트
    `temp` int(11) DEFAULT '0',       -- 임시 포인트
    `timer` int(11) DEFAULT '0',      -- 타이머 포인트
    `eniac` int(11) DEFAULT '0',      -- 문장해독 포인트
    `puzzle` int(11) DEFAULT '0',     -- 퍼즐 포인트
    `bingo` int(11) DEFAULT '0',      -- 빙고 포인트
    PRIMARY KEY (`team`)
);
```

### 데이터 예시
```json
// dc_uploads.files (정식 파일)
["2024_01_15_14_30_25.jpg", "2024_01_15_15_10_30.mp4"]

// dc_uploads.temp (임시 파일)  
["2024_01_15_16_20_15.jpg"]

// dc_uploads.stackFiles (다운로드 상태 추적)
[
    {"file": "2024_01_15_14_30_25.jpg", "download": false},
    {"file": "2024_01_15_15_10_30.mp4", "download": true}
]
```

---

## 제한사항 및 규칙

### 업로드 간격 제한
```javascript
const UPLOAD_TIME_INTERVAL = 180; // 3분 (초 단위)

if ((currentTime - lastUploadTime) < UPLOAD_TIME_INTERVAL) {
    return res.status(201).json({
        error: "연속적으로 업로드 할 수 없습니다. 잠시후 다시 시도해 주시기 바랍니다"
    });
}
```

### 타이머 기반 제한
- **임시저장 모드**에서만 적용
- 타이머가 실행 중이지 않으면 업로드 불가
- 타이머 종료 시 자동으로 임시 항목들 처리

### 파일 형식 제한
클라이언트와 서버 양쪽에서 확장자 검증:
```javascript
const supportedExtensions = {
    video: ['3gp','avi','mov','mp4','mpeg','ogg','ogv','webm','wmv'],
    image: ['jpeg','jpg','png','gif']
};
```

---

## 사용자 인터페이스

### 업로드 컴포넌트 주요 기능

#### 파일 선택 영역
- 드래그 앤 드롭 지원
- 클릭으로 파일 선택
- 실시간 파일 형식/크기 검증

#### 미리보기 영역
```javascript
// 이미지 회전 보정
if (mediaType === 'image') {
    EXIF.getData(file, function() {
        const orientation = EXIF.getTag(this, "Orientation");
        // 회전 각도 계산 및 적용
    });
}

// 비디오 미리보기
if (mediaType === 'video') {
    videoElement.src = URL.createObjectURL(file);
}
```

#### 업로드 진행률
- 실시간 진행률 표시
- 업로드 취소 기능
- 에러 상황 처리

#### 상태 표시
- 정식/임시저장 모드 구분 표시
- 타이머 남은 시간 표시 (임시저장 모드)
- 업로드 간격 카운트다운

### 관리자 인터페이스

#### 타이머 모달
- 전체 팀 타이머 일괄 시작/정지
- 개별 팀 타이머 제어
- "임시저장 모드" 토글 버튼
- 실시간 남은 시간 표시

#### 모니터링 기능
- 각 팀별 업로드 현황
- 임시저장된 파일 수량
- 타이머 종료 시 자동 처리 결과

---

## 기술적 구현

### 프론트엔드 (React)

#### 상태 관리
```javascript
class Upload extends React.Component {
    state = {
        selectedFile: null,
        uploading: false,
        progress: 0,
        mediaType: null,
        previewUrl: null,
        rotationStyle: {}
    };
}
```

#### 업로드 실행
```javascript
uploadHandler = async () => {
    const formData = new FormData();
    formData.append('userFile', this.state.selectedFile);
    formData.append('team', this.props.team);
    formData.append('point', this.props.point);
    formData.append('tempBoxState', this.props.tempBoxState);

    try {
        const response = await axios.post('/user/upload', formData, {
            onUploadProgress: (progressEvent) => {
                const progress = Math.round(
                    (progressEvent.loaded * 100) / progressEvent.total
                );
                this.setState({ progress });
            }
        });
        // 성공 처리
    } catch (error) {
        // 에러 처리  
    }
};
```

### 백엔드 (Node.js + Express)

#### 업로드 엔드포인트
```javascript
app.post('/user/upload', async (req, res) => {
    upload(req, res, async (err) => {
        if (err) return res.status(500).json({ error: err.message });
        
        const { team, point, tempBoxState } = req.body;
        const filename = req.files.userFile[0].filename;
        const currentTime = utils.getCurrentTimestamp();
        const isTemp = parseInt(tempBoxState);
        
        try {
            // 포인트 업데이트
            if (isTemp) {
                await DCQuery.points.update({ team, temp: point });
                await DCQuery.uploads.add(team, filename, currentTime, true);
            } else {
                await DCQuery.points.update({ team, useable: point });
                await DCQuery.uploads.add(team, filename, currentTime, false);
            }
            
            // 스택 파일 추가
            await DCQuery.uploads.addStackFile(team, filename, false);
            
            res.json({ success: true });
        } catch (error) {
            res.status(500).json({ error: error.message });
        }
    });
});
```

#### 검증 엔드포인트들
```javascript
// 업로드 간격 체크
app.post('/user/upload-interval-check', async (req, res) => {
    const { team } = req.body;
    const currentTime = utils.getCurrentTimestamp();
    const result = await DCQuery.uploads.get(team);
    const lastUploadTime = result[0].uploadTime;
    
    if ((currentTime - lastUploadTime) < constants.UPLOAD_TIME_INTERVAL) {
        return res.status(201).json({
            error: "연속적으로 업로드 할 수 없습니다. 잠시후 다시 시도해 주시기 바랍니다"
        });
    }
    
    res.json({ success: true });
});

// 타이머 체크  
app.post('/user/timer-check', async (req, res) => {
    const { team } = req.body;
    const timerResult = await DCQuery.timers.get(team);
    const timer = timerResult[0];
    
    if (!timer.state) {
        return res.status(201).json({
            error: "타이머가 실행되지 않았습니다"
        });
    }
    
    const currentTime = utils.getCurrentTimestamp();
    const td = timer.laptime - (currentTime - timer.startTime);
    
    if (td <= 0) {
        return res.status(201).json({
            error: "시간이 종료되었습니다"
        });
    }
    
    res.json({ success: true, remainingTime: td });
});
```

---

## 요약

이 시스템은 **시간 제한 팀 미션 게임**에 최적화된 파일 업로드 및 포인트 관리 솔루션입니다. 

### 핵심 장점
1. **공정성**: 시간 제한 기반 자동 승인/반려
2. **실시간성**: Socket.IO 기반 실시간 모니터링  
3. **안정성**: 이중 검증 (클라이언트/서버)
4. **확장성**: 모듈화된 포인트 시스템
5. **사용성**: 직관적인 업로드 인터페이스

### 주요 워크플로우
**정식 업로드**: 선택 → 검증 → 업로드 → 즉시 포인트 지급  
**임시저장**: 선택 → 검증 → 업로드 → 타이머 종료 대기 → 자동 승인/반려

이러한 시스템을 통해 관리자의 개입 없이도 공정하고 자동화된 팀 기반 게임 운영이 가능합니다.

---

## 업로드 성공 시 즉시 포인트 지급 분석

### 현재 구현 상태 검증 결과

**✅ 업로드 성공 시 바로 포인트 지급 기능은 이미 구현되어 있습니다.**

#### 1. 포인트 지급 방식 분석
```javascript
// /src/user/userRoute.js - 업로드 엔드포인트
app.post('/user/upload', async (req, res) => {
  upload(req, res, async (err) => {
    if (err) {
      // 업로드 실패 처리
    } else {
      const tempBoxState = parseInt(req.body.tempBoxState);
      
      if (tempBoxState) {
        // 임시저장 모드: temp 포인트로 즉시 저장
        await DCQuery.points.update({
          team,
          temp: point,
        });
      } else {
        // 정식 모드: useable 포인트로 즉시 저장
        await DCQuery.points.update({
          team,
          useable: point,
        });
      }
      res.sendStatus(201); // 업로드 및 포인트 지급 완료
    }
  });
});
```

#### 2. 포인트 지급 특징

| 특징 | 설명 |
|------|------|
| **처리 방식** | 실시간 동기 처리 (배치 처리 없음) |
| **지급 시점** | 파일 업로드 완료와 동시에 즉시 지급 |
| **트랜잭션** | 업로드와 포인트 지급이 하나의 트랜잭션으로 처리 |
| **지연 시간** | 없음 (업로드 성공 = 포인트 지급 완료) |

#### 3. 모드별 포인트 지급 방식

**정식 업로드 모드 (tempBoxState = false)**
- 업로드 성공 → 즉시 `useable` 포인트 지급
- 바로 사용 가능한 포인트로 적립
- 별도의 승인 과정 없음

**임시저장 모드 (tempBoxState = true)**
- 업로드 성공 → 즉시 `temp` 포인트 지급
- 타이머 종료 시 조건 확인:
  - 시간 내 완료: `temp` → `useable` 이동
  - 시간 초과: `temp` 포인트 삭제

#### 4. 포인트 지급 조건
1. **필수 조건**: 파일 업로드 성공
2. **간격 제한**: 마지막 업로드로부터 3분(180초) 경과
3. **임시저장 모드 추가 조건**: 타이머 실행 중이어야 함

#### 5. 에러 핸들링
- 업로드 성공 후 포인트 지급 실패 시 HTTP 401 응답
- 포인트 지급과 업로드가 동일한 트랜잭션에서 처리되어 일관성 보장

### 결론

현재 시스템은 **업로드 성공과 동시에 포인트가 즉시 지급**되는 실시간 시스템으로 구현되어 있습니다. 

- **정식 모드**: 업로드 즉시 사용 가능한 포인트 지급
- **임시저장 모드**: 업로드 즉시 임시 포인트 지급 후 조건부 승인
- **처리 방식**: 동기적 실시간 처리로 지연 없음

추가 개발이 필요하지 않으며, 요구사항이 이미 완전히 구현된 상태입니다.